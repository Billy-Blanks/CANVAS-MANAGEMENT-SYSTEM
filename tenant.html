<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas RentEase - Rent Payment Dashboard</title>
    <style>
      /* --- (kept identical to your original styling) --- */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
      .modal { background: #fff; border-radius: 10px; padding: 20px; max-width: 500px; width: 100%; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); animation: fadeIn 0.3s ease-in-out; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
      .modal-header h2 { font-size: 1.5rem; margin: 0; }
      .close-modal { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }
      .form-group { margin-bottom: 15px; }
      .form-actions { display: flex; justify-content: space-between; }
      @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      :root { --primary: #4361ee; --primary-light: #4cc9f0; --secondary: #7209b7; --success: #2ec4b6; --danger: #e71d36; --warning: #ff9f1c; --dark: #2b2d42; --light: #f8f9fa; --gray: #adb5bd; }
      * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
      body { background-color: #f5f7fa; color: var(--dark); }
      .container { display: flex; min-height: 100vh; }
      .sidebar { width: 250px; background-color: var(--dark); color: white; padding: 1.5rem 0; position: fixed; height: 100vh; overflow-y: auto; }
      .logo { display: flex; align-items: center; padding: 0 1.5rem 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 1.5rem; }
      .logo-icon { font-size: 1.8rem; margin-right: 0.5rem; color: var(--primary-light); }
      .logo h2 { font-weight: 600; font-size: 1.25rem; }
      .nav-menu { list-style: none; }
      .nav-item { margin-bottom: 0.25rem; }
      .nav-link { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: rgba(255, 255, 255, 0.7); text-decoration: none; transition: all 0.3s; }
      .nav-link:hover, .nav-link.active { background: rgba(255, 255, 255, 0.1); color: white; border-left: 4px solid var(--primary-light); }
      .nav-link i { margin-right: 0.75rem; font-size: 1.1rem; }
      .main-content { flex: 1; padding: 2rem; margin-left: 250px; }
      header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
      .header-title h1 { font-size: 1.75rem; font-weight: 600; }
      .header-title p { color: var(--gray); margin-top: 0.25rem; }
      .header-actions { display: flex; gap: 1rem; }
      .btn { padding: 0.5rem 1rem; border-radius: 0.25rem; border: none; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; }
      .btn-primary { background-color: var(--primary); color: white; }
      .btn-primary:hover { background-color: #3050d0; }
      .btn-outline { background-color: transparent; border: 1px solid var(--gray); }
      .btn-outline:hover { background-color: rgba(0, 0, 0, 0.05); }
      .stats-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
      .stat-card { background-color: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); transition: transform 0.3s; }
      .stat-card .icon { width: 3rem; height: 3rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; font-size: 1.5rem; }
      .stat-card.primary .icon { background-color: rgba(67, 97, 238, 0.1); color: var(--primary); }
      .stat-card.success .icon { background-color: rgba(46, 196, 182, 0.1); color: var(--success); }
      .stat-card.warning .icon { background-color: rgba(255, 159, 28, 0.1); color: var(--warning); }
      .stat-card.danger .icon { background-color: rgba(231, 29, 54, 0.1); color: var(--danger); }
      .stat-card h3 { font-size: 1.5rem; margin-bottom: 0.5rem; font-weight: 600; }
      .stat-card p { color: var(--gray); font-size: 0.9rem; }
      .content-section { margin-bottom: 2rem; }
      .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
      .content-header h2 { font-size: 1.25rem; font-weight: 600; }
      .payment-tabs { display: flex; border-bottom: 1px solid var(--gray); margin-bottom: 1.5rem; }
      .payment-tab { padding: 0.75rem 1.5rem; cursor: pointer; position: relative; color: var(--gray); font-weight: 500; }
      .payment-tab.active { color: var(--primary); }
      .payment-tab.active::after { content: ""; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background-color: var(--primary); }
      .table-container { background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); overflow: hidden; }
      table { width: 100%; border-collapse: collapse; }
      th { background-color: #f8f9fa; padding: 1rem; text-align: left; font-weight: 600; color: var(--dark); }
      td { padding: 1rem; border-top: 1px solid #e9ecef; }
      tr:hover { background-color: rgba(0, 0, 0, 0.01); }
      .status { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem; font-weight: 500; }
      .status-paid { background-color: rgba(46, 196, 182, 0.1); color: var(--success); }
      .status-pending { background-color: rgba(255, 159, 28, 0.1); color: var(--warning); }
      .status-overdue { background-color: rgba(231, 29, 54, 0.1); color: var(--danger); }
      .action-btn { background: none; border: none; cursor: pointer; color: var(--primary); margin-right: 0.5rem; }
      .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
      .modal-overlay.active { opacity: 1; visibility: visible; }
      .modal { background-color: white; border-radius: 0.5rem; max-width: 500px; width: 100%; padding: 2rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); transform: translateY(-20px); transition: all 0.3s; }
      .modal-overlay.active .modal { transform: translateY(0); }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
      .modal-header h2 { font-size: 1.25rem; font-weight: 600; }
      .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }
      .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
      .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--gray); border-radius: 0.25rem; font-size: 1rem; }
      .mb-4 { margin-bottom: 1.5rem; }
      .mt-4 { margin-top: 1.5rem; }
      .w-100 { width: 100%; }
      .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
      .mb-3 { margin-bottom: 1rem; }
      @media (max-width: 992px) { .sidebar { width: 80px; overflow: visible; } .logo span, .nav-link span { display: none; } .logo-icon { margin-right: 0; } .logo { justify-content: center; padding: 1.5rem 0; } .nav-link { justify-content: center; padding: 0.75rem; } .nav-link i { margin-right: 0; font-size: 1.25rem; } .main-content { margin-left: 80px; } }
      @media (max-width: 768px) { .stats-cards { grid-template-columns: 1fr; } .main-content { padding: 1.5rem; } .header-actions { flex-direction: column; } }
      @media (max-width: 576px) { .payment-tabs { flex-direction: column; } .payment-tab { width: 100%; text-align: center; } }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://www.paypal.com/sdk/js?client-id=BAAFfy2fUSkzm8aAzVWRIetwSYFN8EpstXtdDXrX6BplsfRiSmjjMrh_aiYWOpU5M7SBZwc3JSkRbwqp74&components=hosted-buttons&disable-funding=venmo&currency=USD"></script>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <div class="logo">
          <div class="logo-icon"><i class="fas fa-home"></i></div>
          <span><h2>Canvas</h2></span>
        </div>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="#dashboard" class="nav-link active" id="dashboardLink">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#payments" class="nav-link" id="paymentsLink">
              <i class="fas fa-credit-card"></i>
              <span>Payments</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#reports" class="nav-link" id="reportsLink">
              <i class="fas fa-receipt"></i>
              <span>Receipts</span>
            </a>
          </li>
        </ul>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
          <header>
            <div class="header-title">
              <h1>Dashboard</h1>
              <p>Welcome back! Here's an overview of your rent payments</p>
            </div>
            <div class="header-actions">
              <button class="btn btn-primary" id="makePaymentBtn">
                <i class="fas fa-plus"></i> Make Payment
              </button>
              <button class="btn btn-outline" id="downloadReportBtn">
                <i class="fas fa-download"></i> Download Report
              </button>
            </div>
          </header>

          <!-- Stats Cards -->
          <div class="stats-cards">
            <div class="stat-card primary">
              <div class="icon">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <h3 id="currentRentValue">Ksh 0.00</h3>
              <p>Current Rent</p>
            </div>
            <div class="stat-card success">
              <div class="icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <h3 id="totalPaidValue">Ksh 0.00</h3>
              <p>Total Paid</p>
            </div>
            <div class="stat-card warning">
              <div class="icon">
                <i class="fas fa-calendar"></i>
              </div>
              <h3 id="daysUntilValue">-</h3>
              <p>Until Next Payment</p>
            </div>
            <div class="stat-card danger">
              <div class="icon">
                <i class="fas fa-exclamation-circle"></i>
              </div>
              <h3 id="overdueAmountValue">Ksh 0.00</h3>
              <p>Overdue Amount</p>
            </div>
          </div>

          <!-- Calendar (moved from Payments to Dashboard) -->
          <div class="card" id="calendarCard">
            <h3>Calendar</h3>
            <div id="calendarHeader" style="display:flex;align-items:center;justify-content:space-between;margin-top:6px;">
              <button id="calendarPrev" class="btn btn-outline" title="Previous Month" style="padding:0.25rem 0.5rem">◀</button>
              <div id="calendarMonthLabel" style="font-weight:600;color:#2b2d42"></div>
              <button id="calendarNext" class="btn btn-outline" title="Next Month" style="padding:0.25rem 0.5rem">▶</button>
            </div>
            <div id="calendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px;"></div>
            <small id="calendarHelp" style="color: var(--gray)">Click a highlighted date to view payments due that day.</small>
          </div>

          <!-- Recent Payments -->
          <div class="content-section">
            <div class="content-header">
              <h2>Recent Payment History</h2>
              <button class="btn btn-outline">View All</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Payment ID</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Method</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="recentPaymentsTable">
                  <!-- Data will be loaded from JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Payments Section -->
        <section id="payments" class="section">
          <header>
            <div class="header-title"><h1>Payments</h1><p>Manage and track all your rent payments</p></div>
            <div class="header-actions"><button class="btn btn-primary" id="makePaymentBtn2"><i class="fas fa-plus"></i> Make Payment</button></div>
          </header>

          <div class="payment-tabs">
            <div class="payment-tab active" data-tab="all">All Payments</div>
            <div class="payment-tab" data-tab="paid">Paid</div>
            <div class="payment-tab" data-tab="pending">Pending</div>
            <div class="payment-tab" data-tab="overdue">Overdue</div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Payment ID</th>
                  <th>Due Date</th>
                  <th>Payment Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Method</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="paymentsTable">
                <!-- Data will be loaded from JavaScript -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Reports/Receipts Section -->
        <section id="reports" class="section">
          <header>
            <div class="header-title">
              <h1>Receipts</h1>
              <p>Download your payment receipts</p>
            </div>
          </header>

          <div class="report-card" id="receiptReport">
            <div class="report-icon">
              <i class="fas fa-receipt"></i>
            </div>
            <div class="report-info">
              <h3>Payment Receipts</h3>
              <p>Download receipts for your completed payments</p>
            </div>
            <button class="btn btn-outline">
              <i class="fas fa-download"></i>
            </button>
          </div>
        </section>
      </main>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
      <div class="modal">
        <div class="modal-header">
          <h2>Lipa na M-PESA</h2>
          <button class="close-modal" id="closePaymentModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group mb-3">
            <label for="phonenumber" class="form-label">Phone Number</label>
            <input type="number" class="form-control" id="phonenumber" placeholder="Enter phone number" />
          </div>

          <div class="form-group mb-3">
            <label for="paymentAmount" class="form-label">Amount</label>
            <input type="number" class="form-control" id="paymentAmount" placeholder="Enter amount" />
          </div>

          <div class="form-actions">
            <button class="btn btn-outline" id="cancelPayment">Cancel</button>
            <button class="btn btn-primary" id="confirmPayment">Confirm</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Include jsPDF from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      // Keep your original data and fetch logic untouched. Only replaced the stats + calendar
      const today = new Date();
      today.setDate(today.getDate());
      const minDate = today.toISOString().split("T")[0];

      let payments = [
        { name: "james njoroge", id: "PAY-1001", dueDate: "2025-04-28", paymentDate: "2025-04-28", amount: 4000, status: "paid", method: "MPESA" },
        { name: "charles ngugi", id: "PAY-1002", dueDate: "2025-03-29", paymentDate: "2025-03-29", amount: 4000, status: "paid", method: "MPESA" },
        { name: "Billy kibet", id: "PAY-1003", dueDate: "2025-03-02", paymentDate: "2025-03-02", amount: 4000, status: "paid", method: "MPESA" },
        { name: "mercy grace", id: "PAY-1004", dueDate: "2025-01-25", paymentDate: "2025-01-25", amount: 4000, status: "paid", method: "MPESA" },
        { name: "jack silvester", id: "PAY-1005", dueDate: "2025-12-30", paymentDate: null, amount: 4000, status: "paid", method: "MPESA" },
        { name: "grace otieno", id: "PAY-1006", dueDate: "2025-06-01", paymentDate: "2025-06-01", amount: 4000, status: "paid", method: "MPESA" },
      ];

      // If your page fetches data from a server later it will still work - this keeps original fetch logic intact
      fetch("http://localhost:3000/payments")
        .then(async (response) => {
          let newPayments = await response.json();
          const urlParams = new URLSearchParams(window.location.search);
          const name = urlParams.get("name");

          if (!name) {
            newPayments = [];
          } else {
            newPayments = newPayments.filter((p) => p.name.toLowerCase() === name.toLowerCase());
          }

          newPayments = newPayments.map((p) => {
            return {
              ...p,
              name: p.name,
              id: p.paymentId,
              status: p.status.toLowerCase(),
              amount: parseFloat(p.amount),
              dueDate: p.date ? new Date(p.date).toISOString() : null,
              paymentDate: p.date ? new Date(p.date).toISOString() : null,
            };
          });
          if (!name) {
            payments = [];
          } else {
            payments = payments.filter((p) => p.name.toLowerCase() === name.toLowerCase());
            payments = [...payments, ...newPayments];
          }

          // after merge - update the stats and calendar
          updateStats();
          generateCalendar();
          loadRecentPayments();
          loadAllPayments();
        })
        .catch((error) => console.error("Error fetching payment data:", error));

      // receipts array kept as in original
      let receipts = payments.filter((p) => p.status === "paid").map((p) => ({ id: p.id, name: p.name, amount: p.amount, method: p.method, date: p.paymentDate || new Date().toISOString() }));

      // DOM references kept
      const sections = document.querySelectorAll(".section");
      const navLinks = document.querySelectorAll(".nav-link");
      const paymentTabs = document.querySelectorAll(".payment-tab");
      const makePaymentBtns = document.querySelectorAll("#makePaymentBtn, #makePaymentBtn2");
      const paymentModal = document.getElementById("paymentModal");
      const closePaymentModal = document.getElementById("closePaymentModal");
      const cancelPayment = document.getElementById("cancelPayment");
      const confirmPayment = document.getElementById("confirmPayment");
      const recentPaymentsTable = document.getElementById("recentPaymentsTable");
      const paymentsTable = document.getElementById("paymentsTable");
      const calendarContainer = document.getElementById("calendar");
      const calendarPrevBtn = document.getElementById("calendarPrev");
      const calendarNextBtn = document.getElementById("calendarNext");
      const calendarMonthLabel = document.getElementById("calendarMonthLabel");
      const downloadReportBtn = document.getElementById("downloadReportBtn");
      const receiptsCardBtn = document.querySelector('#receiptReport .btn');

      // Track displayed calendar month/year
      let calendarYear = new Date().getFullYear();
      let calendarMonth = new Date().getMonth(); // 0-11
      const paymentsLinkEl = document.getElementById("paymentsLink");

      // Calendar filter state
      let calendarFilterActive = false;
      let calendarFilterDateISO = null;

      // Navigation handling (switch sections on sidebar click)
      navLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          // Update active link
          navLinks.forEach((l) => l.classList.remove("active"));
          link.classList.add("active");
          // Show corresponding section
          const targetId = link.getAttribute("href").substring(1);
          sections.forEach((section) => {
            section.style.display = section.id === targetId ? "block" : "none";
          });
          // Clear calendar filter when navigating
          calendarFilterActive = false;
          calendarFilterDateISO = null;
          if (targetId === "payments") {
            const activeTab = document.querySelector(".payment-tab.active");
            const status = activeTab ? activeTab.getAttribute("data-tab") : "all";
            loadAllPayments(status);
          }
        });
      });

      // NEW: improved stats and calendar functions (behavior copied from tenant_mpesa_peruser)
      function updateStats() {
        const currentRentEl = document.getElementById("currentRentValue");
        const totalPaidEl = document.getElementById("totalPaidValue");
        const daysUntilEl = document.getElementById("daysUntilValue");
        const overdueEl = document.getElementById("overdueAmountValue");

        const now = new Date();
        console.log(payments)

        // Total paid overall (sums paid payments currently in the payments array)
        const totalPaid = payments.filter((p) => String(p.status).toLowerCase() === "paid").reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
        totalPaidEl.textContent = `Ksh ${totalPaid.toFixed(2)}`;
        console.log(totalPaid,"billy paid")

        // Paid this month
        const year = now.getFullYear();
        const month = now.getMonth();
        const paidThisMonth = payments
          .filter((p) => String(p.status).toLowerCase() === "paid")
          .filter((p) => {
            const d = new Date(p.paymentDate || p.dueDate);
            return !isNaN(d) && d.getFullYear() === year && d.getMonth() === month;
          })
          .reduce((sum, p) => sum + (Number(p.amount) || 0), 0);

        // Current rent is remaining for this month (uses the same default CURRENT_RENT if you have it on server)
        const CURRENT_RENT = 4000; // keep same default as original behavior
        const remainingThisMonth = Math.max(0, CURRENT_RENT - paidThisMonth);
        currentRentEl.textContent = `Ksh ${remainingThisMonth.toFixed(2)}`;

        // Next due date: first day of next month (keeps your previous UX)
        const nextDue = new Date(year, month + 1, 1);
        const diffMs = nextDue.getTime() - now.getTime();
        const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
        daysUntilEl.textContent = diffDays > 0 ? `${diffDays} Days` : "Due";

        // Overdue amount: if current date past 1st of this month and remaining > 0, that's overdue
        const startOfThisMonth = new Date(year, month, 1);
        const overdueAmount = now > startOfThisMonth ? remainingThisMonth : 0;
        overdueEl.textContent = `Ksh ${overdueAmount.toFixed(2)}`;
      }

      function generateCalendar() {
        if (!calendarContainer) return;
        calendarContainer.innerHTML = "";

        const year = calendarYear;
        const month = calendarMonth;
        const firstDay = new Date(year, month, 1);
        const startWeekday = firstDay.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Add weekday headers
        const weekdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        weekdays.forEach((w) => {
          const el = document.createElement("div");
          el.style.fontWeight = "600";
          el.style.color = "#6c757d";
          el.textContent = w;
          calendarContainer.appendChild(el);
        });

        // Empty cells before first day
        for (let i = 0; i < startWeekday; i++) {
          const empty = document.createElement("div");
          calendarContainer.appendChild(empty);
        }

        // Collect paid dates in this month (for highlighting)
        const paidDaysThisMonth = payments
          .filter((p) => String(p.status).toLowerCase() === "paid")
          .map((p) => new Date(p.paymentDate || p.dueDate))
          .filter((d) => !isNaN(d) && d.getMonth() === month && d.getFullYear() === year)
          .map((d) => d.getDate());

        // Determine next due date (1st of next month)
        const nextDueDate = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1);

        // Update header label
        if (calendarMonthLabel) {
          const label = new Date(year, month, 1).toLocaleDateString("en-US", { month: "long", year: "numeric" });
          calendarMonthLabel.textContent = label;
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement("button");
          cell.textContent = String(day);
          cell.className = "btn btn-outline";
          cell.style.padding = "0.4rem";
          cell.style.fontSize = "0.9rem";
          cell.style.justifyContent = "center";
          cell.style.borderRadius = "0.25rem";

          // Highlight days with payments
          if (paidDaysThisMonth.includes(day)) {
            cell.style.borderColor = "var(--success)";
            cell.style.color = "var(--success)";
            cell.title = "Paid on this date";
          }

          // Highlight next due date if in displayed month
          if (nextDueDate.getMonth() === month && nextDueDate.getFullYear() === year && nextDueDate.getDate() === day) {
            cell.style.borderColor = "var(--primary)";
            cell.style.color = "var(--primary)";
            cell.title = (cell.title ? cell.title + " | " : "") + "Next payment due";
          }

          // Click to filter payments by this calendar date (using normal nav flow)
          cell.addEventListener("click", () => {
            calendarFilterActive = true;
            calendarFilterDateISO = new Date(year, month, day).toISOString();
            if (paymentsLinkEl) {
              paymentsLinkEl.click();
            } else {
              // Fallback to direct section toggle
              navLinks.forEach((navLink) => navLink.classList.remove("active"));
              sections.forEach((section) => { section.style.display = section.id === 'payments' ? 'block' : 'none'; });
              loadAllPayments('all');
            }
          });

          calendarContainer.appendChild(cell);
        }
      }

      // Keep original helpers, table loaders and modal behaviour (unchanged)
      function loadRecentPayments() {
        recentPaymentsTable.innerHTML = "";
        const recentPayments = payments.filter((payment) => payment.status !== "pending").slice(0, 5);
        recentPayments.forEach((payment) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                          <td>${payment.name}</td>
                          <td>${payment.id}</td>
                          <td>${formatDate(payment.paymentDate)}</td>
                          <td>${payment.amount.toFixed(2)}</td>
                          <td><span class="status status-${payment.status}">${capitalizeFirstLetter(payment.status)}</span></td>
                          <td>${payment.method || "N/A"}</td>
                          <td>
                              <button class="action-btn" title="View Receipt"><i class="fas fa-file-alt"></i></button>
                              <button class="action-btn" title="Download Receipt"><i class="fas fa-download"></i></button>
                          </td>
                      `;
          recentPaymentsTable.appendChild(row);
        });
      }

      function loadAllPayments(filter = "all") {
        paymentsTable.innerHTML = "";
        let filteredPayments = payments;
        if (filter !== "all") {
          filteredPayments = payments.filter((payment) => payment.status === filter);
        }
        filteredPayments.forEach((payment) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                          <td>${payment.name}</td>
                          <td>${payment.id}</td>
                          <td>${formatDate(payment.dueDate)}</td>
                          <td>${payment.paymentDate ? formatDate(payment.paymentDate) : "Not Paid"}</td>
                          <td>${payment.amount.toFixed(2)}</td>
                          <td><span class="status status-${payment.status}">${capitalizeFirstLetter(payment.status)}</span></td>
                          <td>${payment.method || "N/A"}</td>
                          <td>
                              ${payment.status === "pending" ? `<button class="action-btn" title="Pay Now"><i class="fas fa-credit-card"></i></button>` : `<button class="action-btn" title="View Receipt"><i class="fas fa-file-alt"></i></button>`}
                              <button class="action-btn" title="Download Receipt"><i class="fas fa-download"></i></button>
                          </td>
                      `;
          paymentsTable.appendChild(row);
        });

        // Add event listeners to "Pay Now" buttons
        document.querySelectorAll('button[title="Pay Now"]').forEach((btn) => {
          btn.addEventListener("click", () => { paymentModal.classList.add("active"); });
        });

        // Add event listeners to per-row receipt download buttons
        document.querySelectorAll('button[title="Download Receipt"]').forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const idCell = e.target.closest("tr").children[1].textContent;
              const payment = payments.find((p) => p.id === idCell);
            if (payment) { downloadSingleReceipt(payment); }
            });
          });

        // Apply calendar filter display if active
        if (calendarFilterActive && calendarFilterDateISO) {
          const matchDisplay = formatDate(calendarFilterDateISO);
              Array.from(paymentsTable.children).forEach((tr) => {
                const dueCell = tr.children[2]?.textContent;
            const payCell = tr.children[3]?.textContent;
            tr.style.display = (dueCell === matchDisplay || payCell === matchDisplay) ? '' : 'none';
          });
                } else {
          Array.from(paymentsTable.children).forEach((tr) => { tr.style.display = ''; });
        }
      }

      function downloadSingleReceipt(payment) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("Payment Receipt", 14, 20);
        const lines = [
          `Name: ${payment.name}`,
          `Payment ID: ${payment.id}`,
          `Date: ${payment.paymentDate ? formatDate(payment.paymentDate) : formatDate(payment.dueDate)}`,
          `Amount: Ksh ${Number(payment.amount).toFixed(2)}`,
          `Method: ${payment.method || "MPESA"}`,
          `Status: ${payment.status}`,
        ];
        lines.forEach((l, i) => doc.text(l, 14, 30 + i * 10));
        doc.save(`${payment.id}_receipt.pdf`);
      }

      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
      }

      function capitalizeFirstLetter(string) { return string.charAt(0).toUpperCase() + string.slice(1); }

      // Modal behaviour (kept as-is)
      makePaymentBtns.forEach((btn) => { btn.addEventListener("click", () => { paymentModal.classList.add("active"); }); });
      if (closePaymentModal) closePaymentModal.addEventListener("click", () => { paymentModal.classList.remove("active"); });
      if (cancelPayment) cancelPayment.addEventListener("click", () => { paymentModal.classList.remove("active"); });

      // Confirm payment functionality
      if (confirmPayment) {
        confirmPayment.addEventListener("click", () => {
          const phoneNumber = document.getElementById("phonenumber").value;
          const amount = document.getElementById("paymentAmount").value;
          
          // Validation
          if (!phoneNumber || !amount) {
            alert("Please fill in both phone number and amount fields.");
            return;
          }
          
          // Normalize Kenyan MSISDN to 2547XXXXXXXX
          function normalizeMsisdn(msisdn) {
            const cleaned = String(msisdn).replace(/\s|\+/g, "");
            if (/^0\d{9}$/.test(cleaned)) return "254" + cleaned.slice(1);
            if (/^254\d{9}$/.test(cleaned)) return cleaned;
            if (/^7\d{8}$/.test(cleaned)) return "254" + cleaned;
            return cleaned; // fallback; server should re-validate
          }
          const msisdn = normalizeMsisdn(phoneNumber);
          if (!/^2547\d{8}$/.test(msisdn)) {
            alert("Please enter a valid Safaricom number (e.g. 07XXXXXXXX or 2547XXXXXXXX).");
            return;
          }
          
          if (parseFloat(amount) <= 0) {
            alert("Please enter a valid amount greater than 0.");
            return;
          }
          // Disable button while processing
          const previousText = confirmPayment.textContent;
          confirmPayment.disabled = true;
          confirmPayment.textContent = "Processing...";

          // Get tenant name for account reference
          const urlParams = new URLSearchParams(window.location.search);
          const tenantName = urlParams.get("name") || "Tenant";

          // Call backend to initiate STK Push
          fetch("http://localhost:3000/pay", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: tenantName,
              phone: msisdn,
              amount: Number(amount),
              accountReference: tenantName,
              description: "Rent Payment"
            })
          })
          .then(async (res) => {
            if (!res.ok) {
              const errText = await res.text().catch(() => "");
              throw new Error(errText || `Request failed (${res.status})`);
            }
            return res.json().catch(() => ({ success: true }));
          })
          .then((data) => {
            alert("STK Push sent. Check your phone to complete the payment.");
            // Optionally close modal here
            paymentModal.classList.remove("active");
          })
          .catch((err) => {
            console.error("STK push error:", err);
            alert("Failed to initiate STK push. Please try again.");
          })
          .finally(() => {
            // Restore button state
            confirmPayment.disabled = false;
            confirmPayment.textContent = previousText;
            // Clear fields
            document.getElementById("phonenumber").value = "";
            document.getElementById("paymentAmount").value = "";
            window.location.reload()
          });
        });
      }

      // Generate payment receipt function
      function generatePaymentReceipt(payment) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Set up the receipt
        doc.setFontSize(20);
        doc.text("PAYMENT RECEIPT", 14, 20);
        
        // Add company info
        doc.setFontSize(12);
        doc.text("Canvas RentEase", 14, 35);
        doc.text("Property Management System", 14, 42);
        doc.text("Email: info@canvasrentease.com", 14, 49);
        doc.text("Phone: +254 700 000 000", 14, 56);
        
        // Add receipt details
        doc.setFontSize(14);
        doc.text("Receipt Details:", 14, 70);
        
        doc.setFontSize(12);
        const receiptData = [
          `Receipt No: ${payment.id}`,
          `Date: ${formatDate(payment.paymentDate)}`,
          `Time: ${new Date(payment.paymentDate).toLocaleTimeString()}`,
          `Tenant: ${payment.name}`,
          `Phone: ${document.getElementById("phonenumber").value}`,
          `Amount: Ksh ${payment.amount.toFixed(2)}`,
          `Payment Method: ${payment.method}`,
          `Status: ${payment.status.toUpperCase()}`,
          `Transaction ID: ${payment.id}-${Date.now()}`
        ];
        
        receiptData.forEach((line, index) => {
          doc.text(line, 14, 85 + (index * 8));
        });
        
        // Add footer
        doc.setFontSize(10);
        doc.text("Thank you for your payment!", 14, 160);
        doc.text("This is a computer generated receipt.", 14, 170);
        doc.text("No signature required.", 14, 180);
        
        // Save the receipt
        doc.save(`${payment.id}_receipt.pdf`);
      }

      // Initialize the enhanced stats + calendar without changing the rest of your page
      document.addEventListener('DOMContentLoaded', () => {
        updateStats();
        loadRecentPayments();
        loadAllPayments();
        generateCalendar();
        if (calendarPrevBtn && calendarNextBtn) {
          calendarPrevBtn.addEventListener('click', () => {
            calendarMonth -= 1;
            if (calendarMonth < 0) { calendarMonth = 11; calendarYear -= 1; }
            generateCalendar();
          });
          calendarNextBtn.addEventListener('click', () => {
            calendarMonth += 1;
            if (calendarMonth > 11) { calendarMonth = 0; calendarYear += 1; }
            generateCalendar();
          });
        }

        // Download overall report (summary of all payments)
        if (downloadReportBtn) {
          downloadReportBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('Payment Report', 14, 20);

            const paid = payments.filter(p => String(p.status).toLowerCase() === 'paid');
            const pending = payments.filter(p => String(p.status).toLowerCase() === 'pending');
            const overdue = payments.filter(p => String(p.status).toLowerCase() === 'overdue');
            const totalPaid = paid.reduce((s, p) => s + (Number(p.amount)||0), 0);

            let y = 32;
            doc.setFontSize(12);
            doc.text(`Total Paid: Ksh ${totalPaid.toFixed(2)}`, 14, y); y += 8;
            doc.text(`Paid Count: ${paid.length}`, 14, y); y += 8;
            doc.text(`Pending Count: ${pending.length}`, 14, y); y += 8;
            doc.text(`Overdue Count: ${overdue.length}`, 14, y); y += 12;

            doc.setFontSize(14); doc.text('Transactions', 14, y); y += 8; doc.setFontSize(11);
            const rows = payments.map(p => `${p.name} | ${p.id} | ${formatDate(p.paymentDate || p.dueDate)} | Ksh ${(Number(p.amount)||0).toFixed(2)} | ${capitalizeFirstLetter(p.status)} | ${p.method||'N/A'}`);
            if (rows.length === 0) {
              doc.text('No transactions available.', 14, y);
            } else {
              rows.forEach((line) => { if (y > 280) { doc.addPage(); y = 20; } doc.text(line, 14, y); y += 7; });
            }
            doc.save('payment_report.pdf');
          });
        }

        // Download receipts from the Receipts card button (all paid)
        if (receiptsCardBtn) {
          receiptsCardBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('Payment Receipts', 14, 20);
            const paid = payments.filter(p => String(p.status).toLowerCase() === 'paid');
            let y = 32;
            if (paid.length === 0) {
              doc.setFontSize(12); doc.text('No receipts available.', 14, y);
            } else {
              doc.setFontSize(12);
              paid.forEach((p, idx) => {
                const line = `- ${p.name} | ${p.id} | ${formatDate(p.paymentDate || p.dueDate)} | Ksh ${(Number(p.amount)||0).toFixed(2)} | ${p.method||'N/A'}`;
                if (y > 280) { doc.addPage(); y = 20; }
                doc.text(line, 14, y);
                y += 8;
              });
            }
            doc.save('receipts.pdf');
          });
        }
      });
    </script>
  </body>
</html>
