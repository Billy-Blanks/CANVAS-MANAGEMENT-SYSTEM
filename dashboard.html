<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas RentEase - Rent Payment Dashboard</title>
    <style>
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation: fadeIn 0.3s ease-in-out;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .modal-header h2 {
        font-size: 1.5rem;
        margin: 0;
      }

      .close-modal {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #888;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-actions {
        display: flex;
        justify-content: space-between;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      :root {
        --primary: #4361ee;
        --primary-light: #4cc9f0;
        --secondary: #7209b7;
        --success: #2ec4b6;
        --danger: #e71d36;
        --warning: #ff9f1c;
        --dark: #2b2d42;
        --light: #f8f9fa;
        --gray: #adb5bd;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: var(--dark);
      }

      .container {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 250px;
        background-color: var(--dark);
        color: white;
        padding: 1.5rem 0;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }

      .logo {
        display: flex;
        align-items: center;
        padding: 0 1.5rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 1.5rem;
      }

      .logo-icon {
        font-size: 1.8rem;
        margin-right: 0.5rem;
        color: var(--primary-light);
      }

      .logo h2 {
        font-weight: 600;
        font-size: 1.25rem;
      }

      .nav-menu {
        list-style: none;
      }

      .nav-item {
        margin-bottom: 0.25rem;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        transition: all 0.3s;
      }

      .nav-link:hover,
      .nav-link.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-left: 4px solid var(--primary-light);
      }

      .nav-link i {
        margin-right: 0.75rem;
        font-size: 1.1rem;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        padding: 2rem;
        margin-left: 250px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }

      .header-title h1 {
        font-size: 1.75rem;
        font-weight: 600;
      }

      .header-title p {
        color: var(--gray);
        margin-top: 0.25rem;
      }

      .header-actions {
        display: flex;
        gap: 1rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        border: none;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: #3050d0;
      }

      .btn-outline {
        background-color: transparent;
        border: 1px solid var(--gray);
      }

      .btn-outline:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }

      /* Dashboard Stats */
      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-card .icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }

      .stat-card.primary .icon {
        background-color: rgba(67, 97, 238, 0.1);
        color: var(--primary);
      }

      .stat-card.success .icon {
        background-color: rgba(46, 196, 182, 0.1);
        color: var(--success);
      }

      .stat-card.warning .icon {
        background-color: rgba(255, 159, 28, 0.1);
        color: var(--warning);
      }

      .stat-card.danger .icon {
        background-color: rgba(231, 29, 54, 0.1);
        color: var(--danger);
      }

      .stat-card h3 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .stat-card p {
        color: var(--gray);
        font-size: 0.9rem;
      }

      /* Content Section */
      .content-section {
        margin-bottom: 2rem;
      }

      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .content-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
      }

      .payment-tabs {
        display: flex;
        border-bottom: 1px solid var(--gray);
        margin-bottom: 1.5rem;
      }

      .payment-tab {
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        position: relative;
        color: var(--gray);
        font-weight: 500;
      }

      .payment-tab.active {
        color: var(--primary);
      }

      .payment-tab.active::after {
        content: "";
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--primary);
      }

      /* Tables */
      .table-container {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background-color: #f8f9fa;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--dark);
      }

      td {
        padding: 1rem;
        border-top: 1px solid #e9ecef;
      }

      tr:hover {
        background-color: rgba(0, 0, 0, 0.01);
      }

      .status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .status-paid {
        background-color: rgba(46, 196, 182, 0.1);
        color: var(--success);
      }

      .status-pending {
        background-color: rgba(255, 159, 28, 0.1);
        color: var(--warning);
      }

      .status-overdue {
        background-color: rgba(231, 29, 54, 0.1);
        color: var(--danger);
      }

      .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--primary);
        margin-right: 0.5rem;
      }

      /* Modals */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background-color: white;
        border-radius: 0.5rem;
        max-width: 500px;
        width: 100%;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        transform: translateY(-20px);
        transition: all 0.3s;
      }

      .modal-overlay.active .modal {
        transform: translateY(0);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .modal-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--gray);
        border-radius: 0.25rem;
        font-size: 1rem;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
      }

      .modal-body {
        margin-bottom: 1rem;
      }

      .mb-4 {
        margin-bottom: 1.5rem;
      }

      .mt-4 {
        margin-top: 1.5rem;
      }

      .w-100 {
        width: 100%;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .mb-3 {
        margin-bottom: 1rem;
      }

      /* Reminder setting section */
      .card {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
      }

      .reminder-option {
        display: flex;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid #e9ecef;
      }

      .reminder-option:last-child {
        border-bottom: none;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
        margin-right: 1rem;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--primary);
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .reminder-text {
        flex: 1;
      }

      .reminder-text h4 {
        font-weight: 500;
        margin-bottom: 0.25rem;
      }

      .reminder-text p {
        color: var(--gray);
        font-size: 0.9rem;
      }

      /* Reports section */
      .report-card {
        display: flex;
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 1rem;
        align-items: center;
        transition: transform 0.3s;
        cursor: pointer;
      }

      .report-card:hover {
        transform: translateY(-5px);
      }

      .report-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.5rem;
        background-color: rgba(67, 97, 238, 0.1);
        color: var(--primary);
      }

      .report-info {
        flex: 1;
      }

      /* Responsiveness */
      @media (max-width: 992px) {
        .sidebar {
          width: 80px;
          overflow: visible;
        }

        .logo span,
        .nav-link span {
          display: none;
        }

        .logo-icon {
          margin-right: 0;
        }

        .logo {
          justify-content: center;
          padding: 1.5rem 0;
        }

        .nav-link {
          justify-content: center;
          padding: 0.75rem;
        }

        .nav-link i {
          margin-right: 0;
          font-size: 1.25rem;
        }

        .main-content {
          margin-left: 80px;
        }
      }

      @media (max-width: 768px) {
        .stats-cards {
          grid-template-columns: 1fr;
        }

        .main-content {
          padding: 1.5rem;
        }

        .header-actions {
          flex-direction: column;
        }
      }

      @media (max-width: 576px) {
        .payment-tabs {
          flex-direction: column;
        }

        .payment-tab {
          width: 100%;
          text-align: center;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://www.paypal.com/sdk/js?client-id=BAAFfy2fUSkzm8aAzVWRIetwSYFN8EpstXtdDXrX6BplsfRiSmjjMrh_aiYWOpU5M7SBZwc3JSkRbwqp74&components=hosted-buttons&disable-funding=venmo&currency=USD"></script>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <div class="logo">
          <div class="logo-icon"><i class="fas fa-home"></i></div>
          <span><h2>Canvas</h2></span>
        </div>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="#dashboard" class="nav-link active" id="dashboardLink">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#payments" class="nav-link" id="paymentsLink">
              <i class="fas fa-credit-card"></i>
              <span>Payments</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#reminders" class="nav-link" id="remindersLink">
              <i class="fas fa-bell"></i>
              <span>Reminders</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#reports" class="nav-link" id="reportsLink">
              <i class="fas fa-chart-bar"></i>
              <span>Reports</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#settings" class="nav-link" id="settingsLink">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </a>
          </li>
        </ul>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
          <header>
            <div class="header-title">
              <h1>Dashboard</h1>
              <p>Welcome back! Here's an overview of your rent payments</p>
            </div>
            <div class="header-actions">
              <button class="btn btn-outline" id="downloadReportBtn">
                <i class="fas fa-download"></i> Download Report
              </button>
            </div>
          </header>

          <!-- Stats Cards -->
          <div class="stats-cards">
            <div class="stat-card success">
              <div class="icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <h3 id="totalPaidAmount">Ksh 0.00</h3>
              <p>Total Paid Amount</p>
            </div>
            <div class="stat-card danger">
              <div class="icon">
                <i class="fas fa-exclamation-circle"></i>
              </div>
              <h3 id="overdueAmount">Ksh 0.00</h3>
              <p>Overdue Amount</p>
            </div>
            <div class="stat-card primary">
              <div class="icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <h3 id="monthlyTotal">Ksh 0.00</h3>
              <p>This Month's Total</p>
            </div>
            <div class="stat-card warning">
              <div class="icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <h3 id="yearlyTotal">Ksh 0.00</h3>
              <p>This Year's Total</p>
            </div>
          </div>

          <!-- Recent Payments -->
          <div class="content-section">
            <div class="content-header">
              <h2>Recent Payment History</h2>
              <button class="btn btn-outline">View All</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Payment ID</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Method</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="recentPaymentsTable">
                  <!-- Data will be loaded from JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Payments Section -->
        <section id="payments" class="section">
          <header>
            <div class="header-title">
              <h1>Payments</h1>
              <p>Manage and track all your rent payments</p>
            </div>
          </header>

          <div class="payment-tabs">
            <div class="payment-tab active" data-tab="all">All Payments</div>
            <div class="payment-tab" data-tab="paid">Paid</div>
            <div class="payment-tab" data-tab="pending">Pending</div>
            <div class="payment-tab" data-tab="overdue">Overdue</div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Payment ID</th>
                  <th>Due Date</th>
                  <th>Payment Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Method</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="paymentsTable">
                <!-- Data will be loaded from JavaScript -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Reminders Section -->
        <section id="reminders" class="section">
          <header>
            <div class="header-title">
              <h1>Reminders</h1>
              <p>Setup automated payment reminders</p>
            </div>
          </header>

          <div class="card">
            <div class="reminder-option">
              <label class="switch">
                <input type="checkbox" checked />
                <span class="slider"></span>
              </label>
              <div class="reminder-text">
                <h4>7 Days Before Due Date</h4>
                <p>Receive an email reminder 7 days before rent is due</p>
              </div>
            </div>
            <div class="reminder-option">
              <label class="switch">
                <input type="checkbox" checked />
                <span class="slider"></span>
              </label>
              <div class="reminder-text">
                <h4>3 Days Before Due Date</h4>
                <p>Receive an email reminder 3 days before rent is due</p>
              </div>
            </div>
            <div class="reminder-option">
              <label class="switch">
                <input type="checkbox" checked />
                <span class="slider"></span>
              </label>
              <div class="reminder-text">
                <h4>1 Day Before Due Date</h4>
                <p>Receive an email reminder 1 day before rent is due</p>
              </div>
            </div>
            <div class="reminder-option">
              <label class="switch">
                <input type="checkbox" />
                <span class="slider"></span>
              </label>
              <div class="reminder-text">
                <h4>SMS Notifications</h4>
                <p>Receive SMS reminders for upcoming payments</p>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Custom Reminder</h3>
            <p class="mb-4">Set a custom reminder for special payments</p>
            <div class="form-group">
              <label for="reminderTitle">Title</label>
              <input
                type="text"
                class="form-control"
                id="reminderTitle"
                placeholder="e.g. Security Deposit"
              />
            </div>
            <div class="form-group">
              <label for="reminderDate">Date</label>
              <input type="date" class="form-control" id="reminderDate" />
            </div>
            <div class="form-group">
              <label for="reminderMessage">Message</label>
              <textarea
                class="form-control"
                id="reminderMessage"
                rows="3"
                placeholder="Custom reminder message"
              ></textarea>
            </div>
            <button class="btn btn-primary">Add Reminder</button>
          </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="section">
          <header>
            <div class="header-title">
              <h1>Reports</h1>
              <p>Generate and download payment reports</p>
            </div>
          </header>

          <div class="report-card" id="monthlyReport">
            <div class="report-icon">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="report-info">
              <h3>Monthly Payment Report</h3>
              <p>Summary of all payments made in the current month</p>
            </div>
            <button class="btn btn-outline">
              <i class="fas fa-download"></i>
            </button>
          </div>

          <div class="report-card" id="yearlyReport">
            <div class="report-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="report-info">
              <h3>Annual Payment Summary</h3>
              <p>Complete report of all transactions in the current year</p>
            </div>
            <button class="btn btn-outline">
              <i class="fas fa-download"></i>
            </button>
          </div>

          <div class="report-card" id="receiptReport">
            <div class="report-icon">
              <i class="fas fa-receipt"></i>
            </div>
            <div class="report-info">
              <h3>Payment Receipts</h3>
              <p>Download individual receipts for all completed payments</p>
            </div>
            <button class="btn btn-outline">
              <i class="fas fa-download"></i>
            </button>
          </div>

          
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
          <header>
            <div class="header-title">
              <h1>Settings</h1>
              <p>Manage your account and payment preferences</p>
            </div>
          </header>

          <div class="card">
            <h3>Security Settings</h3>
            <div class="form-group">
              <label for="currentPassword">Current Password</label>
              <input
                type="password"
                class="form-control"
                id="currentPassword"
              />
            </div>
            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input type="password" class="form-control" id="newPassword" />
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm New Password</label>
              <input
                type="password"
                class="form-control"
                id="confirmPassword"
              />
            </div>
            <button class="btn btn-primary">Update Password</button>
          </div>

        </section>
      </main>
    </div>


    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
      <div class="modal">
        <div class="modal-header">
          <h2>Lipa na M-PESA</h2>
          <button class="close-modal" id="closePaymentModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group mb-3">
            <label for="phonenumber" class="form-label">Phone Number</label>
            <input
              type="number"
              class="form-control"
              id="phonenumber"
              placeholder="Enter phone number"
            />
          </div>

          <div class="form-group mb-3">
            <label for="paymentAmount" class="form-label">Amount</label>
            <input
              type="number"
              class="form-control"
              id="paymentAmount"
              placeholder="Enter amount"
            />
          </div>

          <div class="form-actions">
            <button class="btn btn-outline" id="cancelPayment">Cancel</button>
            <button class="btn btn-primary" id="confirmPayment">Confirm</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Include jsPDF from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      const today = new Date();
      today.setDate(today.getDate());
      const minDate = today.toISOString().split("T")[0];
      document.getElementById("reminderDate").setAttribute("min", minDate);
      let payments = [
        {
          name: "james njoroge",
          id: "PAY-1001",
          dueDate: "2025-04-28",
          paymentDate: "2025-04-28",
          amount: 4000,
          status: "paid",
          method: "MPESA",
        },
        {
          name: "charles ngugi",
          id: "PAY-1002",
          dueDate: "2025-03-29",
          paymentDate: "2025-03-29",
          amount: 4000,
          status: "paid",
          method: "MPESA",
        },
        {
          name: "Billy kibet",
          id: "PAY-1003",
          dueDate: "2025-03-02",
          paymentDate: "2025-03-02",
          amount: 4000,
          status: "paid",
          method: "MPESA",
        },
        {
          name: "mercy grace",
          id: "PAY-1004",
          dueDate: "2025-01-25",
          paymentDate: "2025-01-25",
          amount: 4000,
          status: "paid",
          method: "MPESA",
        },
        {
          name: "jack silvester",
          id: "PAY-1005",
          dueDate: "2025-12-30",
          paymentDate: "2025-12-30",
          amount: 4000,
          status: "paid",
          method: "MPESA",
        },
        {
          name: "grace otieno",
          id: "PAY-1006",
          dueDate: "2025-06-01",
          paymentDate: "2025-06-01",
          amount: 4000,
          status: "paid",
          method: "MPESA",
        },
      ];

      // Load locally stored payments (from tenant page) and optional tenant filter
      const urlParams = new URLSearchParams(window.location.search);
      const urlTenantName = urlParams.get("name");
      function dedupeById(arr) {
        const seen = new Set();
        return arr.filter((p) => {
          const key = p && p.id ? String(p.id) : Math.random();
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
      }
      let localPayments = [];
      try {
        localPayments = JSON.parse(localStorage.getItem('payments') || '[]');
      } catch (_) { localPayments = []; }
      if (localPayments.length) {
        payments = dedupeById([...payments, ...localPayments]);
      }
      if (urlTenantName) {
        payments = payments.filter(p => String(p.name).toLowerCase() === urlTenantName.toLowerCase());
      }

      fetch("http://localhost:3000/payments")
        .then(async (response) => {
          let newPayments = await response.json();
          console.log(newPayments);
          newPayments = newPayments.map((p) => {
            return {
              ...p,
              name: p.name,
              id: p.paymentId,
              status: p.status.toLowerCase(),
              amount: parseFloat(p.amount),
              dueDate: p.date ? new Date(p.date).toLocaleDateString() : null,
              paymentDate: p.date
                ? new Date(p.date).toLocaleDateString()
                : null,
            };
          });
          // Merge: existing (possibly filtered), server, and any local payments, then dedupe
          let merged = dedupeById([...(payments || []), ...newPayments, ...localPayments]);
          // Re-apply tenant filter if present
          payments = urlTenantName ? merged.filter(p => String(p.name).toLowerCase() === urlTenantName.toLowerCase()) : merged;
          console.log(payments);
          loadAllPayments();
          loadRecentPayments();
          updateDashboardStats();
        })
        .catch((error) => {
          console.error("Error fetching payment data:", error);
          // Ensure UI still updates with local/base data
          loadAllPayments();
          loadRecentPayments();
          updateDashboardStats();
        });
      // Sample Data


      // DOM Elements
      const sections = document.querySelectorAll(".section");
      const navLinks = document.querySelectorAll(".nav-link");
      const paymentTabs = document.querySelectorAll(".payment-tab");
      const paymentModal = document.getElementById("paymentModal");
      const closePaymentModal = document.getElementById("closePaymentModal");
      const cancelPayment = document.getElementById("cancelPayment");
      const confirmPayment = document.getElementById("confirmPayment");
      const recentPaymentsTable = document.getElementById(
        "recentPaymentsTable"
      );
      const paymentsTable = document.getElementById("paymentsTable");
      const successAlert = document.getElementById("successAlert");

      // Initial page load
      document.addEventListener("DOMContentLoaded", () => {
        // Set current date for payment date input
        const paymentDateInput = document.getElementById("paymentDate");
        if (paymentDateInput) {
          paymentDateInput.value = new Date().toISOString().split("T")[0];
        }

        // Load tables
        loadRecentPayments();
        loadAllPayments();
        updateDashboardStats();

        // Hide all sections except dashboard
        sections.forEach((section) => {
          if (section.id !== "dashboard") {
            section.style.display = "none";
          }
        });
      });

      // Navigation
      navLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();

          // Update active link
          navLinks.forEach((navLink) => navLink.classList.remove("active"));
          link.classList.add("active");

          // Show corresponding section
          const targetId = link.getAttribute("href").substring(1);
          sections.forEach((section) => {
            section.style.display = section.id === targetId ? "block" : "none";
          });
        });
      });

      // Payment Tabs
      paymentTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          // Update active tab
          paymentTabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          // Filter payments by status
          const status = tab.getAttribute("data-tab");
          loadAllPayments(status);
        });
      });

      closePaymentModal.addEventListener("click", () => {
        paymentModal.classList.remove("active");
      });

      if (cancelPayment) {
        cancelPayment.addEventListener("click", () => {
          paymentModal.classList.remove("active");
        });
      }

      if (confirmPayment) {
        // Form Submissions
        confirmPayment.addEventListener("click", async () => {
          const amount = document.getElementById("paymentAmount").value;
          const phoneNumber = document.getElementById("phonenumber").value;
          const date = Date.now();
          const method = "MPESA";

          // Simple validation
          if (!amount || !date || !method) {
            alert("Please fill in all required fields", "error");
            return;
          }

          // In a real application, you would send this data to a server
          // For demo purposes, we'll just show a success message
          paymentModal.classList.remove("active");
          alert("Payment successful! Your receipt has been emailed.");
          const urlParams = new URLSearchParams(window.location.search);
          const name = urlParams.get("name");
          // Add new payment to the list and refresh tables
          const newPayment = {
            name: name,
            id: `PAY-${1007 + payments.length}`,
            dueDate: date,
            paymentDate: date,
            amount: parseFloat(amount),
            status: "paid",
            phone: phoneNumber,
            method: getMethodName(method),
          };

          const res = await fetch("http://localhost:3000/pay", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(newPayment),
          });

          console.log("Payment response:", res);

          payments.unshift(newPayment);
          loadRecentPayments();
          loadAllPayments();
          updateDashboardStats();
        });
      }


      // Helper Functions
      function loadRecentPayments() {
        recentPaymentsTable.innerHTML = "";
        const recentPayments = payments
          .filter((payment) => payment.status !== "pending")
          .slice(0, 5);

        recentPayments.forEach((payment) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                          <td>${payment.name}</td>
                          <td>${payment.id}</td>
                          <td>${formatDate(payment.paymentDate)}</td>
                          <td>${payment.amount.toFixed(2)}</td>
                          <td><span class="status status-${
                            payment.status
                          }">${capitalizeFirstLetter(
            payment.status
          )}</span></td>
                          <td>${payment.method || "N/A"}</td>
                          <td>
                              <button class="action-btn" title="View Receipt"><i class="fas fa-file-alt"></i></button>
                              <button class="action-btn" title="Download Receipt"><i class="fas fa-download"></i></button>
                          </td>
                      `;
          recentPaymentsTable.appendChild(row);
        });
      }

      function loadAllPayments(filter = "all") {
        console.log("Loading all payments with filter:", filter);
        paymentsTable.innerHTML = "";
        let filteredPayments = payments;
        console.log("Payments before filtering:", payments);
        if (filter !== "all") {
          filteredPayments = payments.filter(
            (payment) => payment.status === filter
          );
        }
        console.log("Filtered payments:", filteredPayments);

        filteredPayments.forEach((payment) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                          <td>${payment.name}</td>
                          <td>${payment.id}</td>
                          <td>${formatDate(payment.dueDate)}</td>
                          <td>${
                            payment.paymentDate
                              ? formatDate(payment.paymentDate)
                              : "Not Paid"
                          }</td>
                          <td>${payment.amount.toFixed(2)}</td>
                          <td><span class="status status-${
                            payment.status
                          }">${capitalizeFirstLetter(
            payment.status
          )}</span></td>
                          <td>${payment.method || "N/A"}</td>
                          <td>
                              ${
                                payment.status === "pending"
                                  ? `<button class="action-btn" title="Pay Now"><i class="fas fa-credit-card"></i></button>`
                                  : `<button class="action-btn" title="View Receipt"><i class="fas fa-file-alt"></i></button>`
                              }
                              <button class="action-btn" title="Download Receipt"><i class="fas fa-download"></i></button>
                          </td>
                      `;
          paymentsTable.appendChild(row);
        });

        // Add event listeners to "Pay Now" buttons
        document.querySelectorAll('button[title="Pay Now"]').forEach((btn) => {
          btn.addEventListener("click", () => {
            paymentModal.classList.add("active");
          });
        });
      }


      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      function getMethodName(method) {
        const methods = {
          credit: "Credit Card",
          debit: "Debit Card",
          bank: "Bank Transfer",
          paypal: "PayPal",
          MPESA: "MPESA",
        };
        return methods[method] || method;
      }

      function showAlert(message, type = "info") {
        alert(message);
      }

      // Function to update dashboard statistics
      function updateDashboardStats() {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        // Calculate total paid amount (sum of all paid payments)
        const totalPaid = payments
          .filter(payment => payment.status === 'paid')
          .reduce((sum, payment) => sum + (payment.amount || 0), 0);
        
        // Calculate overdue amount (sum of overdue payments)
        const overdueAmount = payments
          .filter(payment => payment.status === 'overdue')
          .reduce((sum, payment) => sum + (payment.amount || 0), 0);
        
        // Calculate monthly total (payments made in current month)
        const monthlyTotal = payments
          .filter(payment => {
            if (!payment.paymentDate) return false;
            const paymentDate = new Date(payment.paymentDate);
            return payment.status === 'paid' && 
                   paymentDate.getMonth() === currentMonth && 
                   paymentDate.getFullYear() === currentYear;
          })
          .reduce((sum, payment) => sum + (payment.amount || 0), 0);
        
        // Calculate yearly total (payments made in current year)
        const yearlyTotal = payments
          .filter(payment => {
            if (!payment.paymentDate) return false;
            const paymentDate = new Date(payment.paymentDate);
            return payment.status === 'paid' && 
                   paymentDate.getFullYear() === currentYear;
          })
          .reduce((sum, payment) => sum + (payment.amount || 0), 0);
        
        // Update the DOM elements
        document.getElementById('totalPaidAmount').textContent = `Ksh ${totalPaid.toFixed(2)}`;
        document.getElementById('overdueAmount').textContent = `Ksh ${overdueAmount.toFixed(2)}`;
        document.getElementById('monthlyTotal').textContent = `Ksh ${monthlyTotal.toFixed(2)}`;
        document.getElementById('yearlyTotal').textContent = `Ksh ${yearlyTotal.toFixed(2)}`;
      }

      // Secure System Features
      // In a real application, these functions would communicate with a backend server
      function encryptData(data) {
        // This is a placeholder - actual encryption would happen on a secure server
        console.log("Data securely encrypted");
        return data;
      }

      function verifyPayment(paymentData) {
        // This is a placeholder - actual verification would happen on a secure server
        console.log("Payment verified");
        return true;
      }

      function generateSecureToken() {
        // This is a placeholder - actual token generation would happen on a secure server
        return "sec_" + Math.random().toString(36).substr(2, 9);
      }

      // Initialize dashboard with secure session
      const secureToken = generateSecureToken();
      console.log("Secure session initialized with token:", secureToken);

      // Download Report Button Handler
      document
        .getElementById("downloadReportBtn")
        .addEventListener("click", async () => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // Calculate summary statistics
          const totalPaid = payments
            .filter(payment => payment.status === 'paid')
            .reduce((sum, payment) => sum + (payment.amount || 0), 0);
          
          const totalTransactions = payments.length;
          const paidTransactions = payments.filter(p => p.status === 'paid').length;
          const pendingTransactions = payments.filter(p => p.status === 'pending').length;
          const overdueTransactions = payments.filter(p => p.status === 'overdue').length;

          // Add title and summary
          doc.setFontSize(16);
          doc.text("Complete Payment Transactions Report", 14, 20);
          
          doc.setFontSize(12);
          doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 35);
          doc.text(`Total Transactions: ${totalTransactions}`, 14, 45);
          doc.text(`Paid Transactions: ${paidTransactions}`, 14, 55);
          doc.text(`Pending Transactions: ${pendingTransactions}`, 14, 65);
          doc.text(`Overdue Transactions: ${overdueTransactions}`, 14, 75);
          doc.text(`Total Amount Paid: KES ${totalPaid.toFixed(2)}`, 14, 85);

          // Add table header
          doc.setFontSize(10);
          let startY = 100;
          doc.text("Name", 14, startY);
          doc.text("Payment ID", 50, startY);
          doc.text("Date", 90, startY);
          doc.text("Amount", 130, startY);
          doc.text("Status", 160, startY);
          doc.text("Method", 190, startY);

          // Add separator line
          startY += 5;
          doc.line(14, startY, 200, startY);

          // Add payment data
          startY += 10;
          payments.forEach((payment, index) => {
            if (startY > 280) {
              doc.addPage();
              startY = 20;
              // Add header again on new page
              doc.setFontSize(10);
              doc.text("Name", 14, startY);
              doc.text("Payment ID", 50, startY);
              doc.text("Date", 90, startY);
              doc.text("Amount", 130, startY);
              doc.text("Status", 160, startY);
              doc.text("Method", 190, startY);
              startY += 15;
            }

            doc.text(payment.name || "N/A", 14, startY);
            doc.text(payment.id || "N/A", 50, startY);
            doc.text(formatDate(payment.paymentDate) || "N/A", 90, startY);
            doc.text(`KES ${(payment.amount || 0).toFixed(2)}`, 130, startY);
            doc.text(capitalizeFirstLetter(payment.status || "N/A"), 160, startY);
            doc.text(payment.method || "N/A", 190, startY);
            
            startY += 8;
          });

          // Save the PDF
          doc.save("complete_payment_transactions_report.pdf");
        });

      // (Custom report removed)

      // Enable the three static download buttons in report cards
      const { jsPDF } = window.jspdf;
      let receipts = [
        {
          name: "james njoroge",
          id: "PAY-1001",
          amount: "4000",
          method: "M-PESA",
        },
        {
          name: "charles ngugi",
          id: "PAY-1002",
          amount: "4000",
          method: "M-PESA",
        },
        {
          name: "Billy kibet",
          id: "PAY-1003",
          amount: "4000",
          method: "M-PESA",
        },
        {
          name: "mercy grace",
          id: "PAY-1004",
          amount: "4000",
          method: "M-PESA",
        },
      ];
      // Wire report buttons to generate from merged in-memory `payments`
      const monthlyBtn = document.querySelector('#monthlyReport .btn');
      const yearlyBtn = document.querySelector('#yearlyReport .btn');
      const receiptsBtn = document.querySelector('#receiptReport .btn');

      function getMergedPaymentsForReports() {
        let local = [];
        try { local = JSON.parse(localStorage.getItem('payments') || '[]'); } catch (_) { local = []; }
        return dedupeById([...(payments || []), ...local]);
      }

      function generateMonthlyReport() {
        const all = getMergedPaymentsForReports();
        const now = new Date();
        const m = now.getMonth();
        const y = now.getFullYear();
        const monthly = all.filter(p => {
          const d = p.paymentDate || p.dueDate;
          if (!d) return false;
          const dt = new Date(d);
          return String(p.status).toLowerCase() === 'paid' && dt.getMonth() === m && dt.getFullYear() === y;
        });
        const total = monthly.reduce((s,p)=> s + (Number(p.amount)||0), 0);
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(14); doc.text(`Monthly Payment Report - ${now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`, 14, 20);
        doc.setFontSize(12); let yPos = 32;
        doc.text(`Total Payments: ${monthly.length}`, 14, yPos); yPos += 8;
        doc.text(`Total Amount: KES ${total.toFixed(2)}`, 14, yPos); yPos += 12;
        doc.setFontSize(11);
        monthly.forEach((p) => { if (yPos > 280) { doc.addPage(); yPos = 20; } doc.text(`- ${p.name} | ${p.id} | KES ${(Number(p.amount)||0).toFixed(2)} | ${p.method||'N/A'} | ${new Date(p.paymentDate||p.dueDate).toLocaleDateString()}`, 14, yPos); yPos += 7; });
        doc.save('monthly_report.pdf');
      }

      function generateAnnualReport() {
        const all = getMergedPaymentsForReports();
        const now = new Date();
        const y = now.getFullYear();
        const yearly = all.filter(p => {
          const d = p.paymentDate || p.dueDate;
          if (!d) return false;
          const dt = new Date(d);
          return String(p.status).toLowerCase() === 'paid' && dt.getFullYear() === y;
        });
        const total = yearly.reduce((s,p)=> s + (Number(p.amount)||0), 0);
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(14); doc.text(`Annual Payment Summary - ${y}`, 14, 20);
        doc.setFontSize(12); let yPos = 32;
        doc.text(`Total Transactions: ${yearly.length}`, 14, yPos); yPos += 8;
        doc.text(`Total Amount: KES ${total.toFixed(2)}`, 14, yPos); yPos += 12;
        doc.setFontSize(11);
        yearly.forEach((p) => { if (yPos > 280) { doc.addPage(); yPos = 20; } doc.text(`- ${p.name} | ${p.id} | KES ${(Number(p.amount)||0).toFixed(2)} | ${p.method||'N/A'} | ${new Date(p.paymentDate||p.dueDate).toLocaleDateString()}`, 14, yPos); yPos += 7; });
        doc.save('annual_report.pdf');
      }

      function generateReceiptsList() {
        const all = getMergedPaymentsForReports();
        const paid = all.filter(p => String(p.status).toLowerCase() === 'paid');
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(14); doc.text('Payment Receipts', 14, 20);
        doc.setFontSize(11); let yPos = 32;
        if (paid.length === 0) { doc.text('No receipts available.', 14, yPos); doc.save('receipts.pdf'); return; }
        paid.forEach((p) => { if (yPos > 280) { doc.addPage(); yPos = 20; } doc.text(`- ${p.name} | ${p.id} | Amount: KES ${(Number(p.amount)||0).toFixed(2)} | Method: ${p.method||'N/A'} | Date: ${new Date(p.paymentDate||p.dueDate).toLocaleDateString()}`, 14, yPos); yPos += 7; });
        doc.save('receipts.pdf');
      }

      if (monthlyBtn) monthlyBtn.addEventListener('click', generateMonthlyReport);
      if (yearlyBtn) yearlyBtn.addEventListener('click', generateAnnualReport);
      if (receiptsBtn) receiptsBtn.addEventListener('click', generateReceiptsList);

      // Settings: Update Password
      (function wireUpdatePassword() {
        const updateBtn = document.querySelector('#settings .card button.btn.btn-primary');
        if (!updateBtn) return;
        updateBtn.addEventListener('click', async () => {
          const currentPasswordEl = document.getElementById('currentPassword');
          const newPasswordEl = document.getElementById('newPassword');
          const confirmPasswordEl = document.getElementById('confirmPassword');
          const currentPassword = (currentPasswordEl?.value || '').trim();
          const newPassword = (newPasswordEl?.value || '').trim();
          const confirmPassword = (confirmPasswordEl?.value || '').trim();

          if (!currentPassword || !newPassword || !confirmPassword) {
            alert('Please fill in all password fields.');
            return;
          }
          if (newPassword !== confirmPassword) {
            alert('New password and confirmation do not match.');
            return;
          }
          if (newPassword.length < 8) {
            alert('New password must be at least 8 characters long.');
            return;
          }

          try {
            const res = await fetch('http://localhost:3000/update-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Auth-Token': secureToken },
              body: JSON.stringify({ currentPassword, newPassword })
            });
            const contentType = res.headers.get('content-type') || '';
            if (!res.ok) {
              let message = 'Failed to update password';
              if (contentType.includes('application/json')) {
                const j = await res.json();
                message = j.error || message;
              } else {
                const t = await res.text();
                message = t || message;
              }
              alert(message);
              return;
            }
            if (contentType.includes('application/json')) {
              await res.json();
            } else {
              await res.text();
            }
            alert('Password updated successfully.');
            if (currentPasswordEl) currentPasswordEl.value = '';
            if (newPasswordEl) newPasswordEl.value = '';
            if (confirmPasswordEl) confirmPasswordEl.value = '';
          } catch (err) {
            console.error('Update password error:', err);
            alert('An error occurred while updating the password.');
          }
        });
      })();

      // Handle adding custom reminders
      const addReminderButton = document.querySelector(
        "#reminders .card button.btn.btn-primary"
      );
      addReminderButton.addEventListener("click", () => {
        const title = document.getElementById("reminderTitle").value.trim();
        const date = document.getElementById("reminderDate").value;
        const message = document.getElementById("reminderMessage").value.trim();

        if (!title || !date || !message) {
          alert("Please fill in all fields for the reminder.");
          return;
        }

        const reminderHTML = `
          <div class="reminder-option">
            <label class="switch">
              <input type="checkbox" checked />
              <span class="slider"></span>
            </label>
            <div class="reminder-text">
              <h4>${title}</h4>
              <p>${message} — <strong>${date}</strong></p>
            </div>
          </div>
        `;

        const cardElements = document.querySelectorAll("#reminders .card");
        if (cardElements.length > 0) {
          // Append new reminder to the first card
          cardElements[0].insertAdjacentHTML("beforeend", reminderHTML);

          // Clear the form
          document.getElementById("reminderTitle").value = "";
          document.getElementById("reminderDate").value = "";
          document.getElementById("reminderMessage").value = "";

          alert("Reminder added successfully!");
        }
      });
    </script>
  </body>
</html>
